<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>手动组卷</title>
    <link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    <script src="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
</head>
<body onload="init()">
<div class="modal fade" id="addModal" tabindex="-1" aria-labelledby="addModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addModalLabel">选择题目</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="form-group">
                        <label for="smallquestionType" class="col-form-label">题目类型</label>
                        <select class="form-control" id="smallquestionType" onchange="selectChange()">
                            <option value="singleChoiceQuestion">单选题</option>
                            <option value="multipleChoiceQuestion">多选题</option>
                            <option value="completion">填空题</option>
                            <option value="judgment">判断题</option>
                            <option value="comprehensiveQuestion">综合题</option>
                            <option value="programProblem">程序题</option>
                            <option value="combinationChoice">组合选择题</option>
                        </select>
                    </div>
                    <div>
                        <label>题目：</label>
                        <div id="chooseAddQuestion"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="submitAddSmall()">确定</button>
            </div>
        </div>
    </div>
</div>
<div class="container">
    <form id="paperform">
        <div class="form-group">
            <label for="foreWord">简介：</label>
            <input type="text" class="form-control" id="foreWord">
        </div>
        <div class="form-group">
            <label for="course">课程：</label>
            <select class="form-control" id="course" onchange="courseChange()">

            </select>
        </div>
        <div class="form-group">
            <label for="question">题目：</label>
            <div id="question">

            </div>
        </div>
        <div class="form-group">
            <label for="difficulty">难度：</label>
            <select class="form-control" id="difficulty">
                <option>1</option>
                <option>2</option>
                <option>3</option>
                <option>4</option>
                <option>5</option>
                <option>6</option>
                <option>7</option>
                <option>8</option>
                <option>9</option>
                <option>10</option>
            </select>
        </div>
    </form>
    <div id="subbutton"></div>
</div>
</body>
<script>
    $.fn.serializeObject = function() {
        var o = {};
        var a = this.serializeArray();
        $.each(a, function() {
            if (o[this.name]) {
                if (!o[this.name].push) {
                    o[this.name] = [ o[this.name] ];
                }
                o[this.name].push(this.value || '');
            } else {
                o[this.name] = this.value || '';
            }
        });
        return o;
    }

    function submitPaper(id) {
        //整理要交的questionids
        //先删小题
        for(var i=questionids.length-1;i>=0;i--){
            for(var j=questionids[i].length-1;j>=0;j--){
                for(var t=0;t<remSma.length;t++){
                    if([i,j]==remSma[t].toString()){
                        questionids[i].splice(j,1);
                        remSma.splice(t,1);
                        break;
                    }
                }
            }
        }
        //删大题
        for(var i=questionids.length-1;i>=0;i--){
            for(var j=0;j<remHuge.length;j++){
                if(remHuge[j]==i){
                    questionids.splice(i,1);
                    remHuge.splice(j,1);
                    break;
                }
            }
        }

        var foreWord=$('#foreWord').val();
        var course = $("#course").val();
        var isopen=$("#isopen").val();
        var difficulty=$("#difficulty").val();
        var param={
            "id":id,
            "foreWord":foreWord,
            "subjectIDs[][]":questionids,
            "courseID":course,
            "open":isopen,
            "difficulty":difficulty
        }
        jQuery.post("/bank/edit/getfrom",param,function (rst) {
            location.href="bank/operate/paper_control.html";
        })
    }
</script>
<script>
    var questionids=null;
    function init(){
        var locid;
        jQuery.ajax({
            async : false,
            type: 'post',
            url: "/bank/edit/new",
            success:function (rst) {
                locid=rst.id;
            }
        })
        var t=`<button type="button" class="btn btn-light" onclick="submitPaper('`+locid+`')">提交</button>`;
        jQuery("#subbutton").html(t);
        jQuery.ajax({async : false,url: "/bank/edit/getAllCourse",success:function (rst) {
                var coursein="";
                for(var i=0;i<rst.length;i++){
                    coursein=coursein+`<option value="${rst[i].classifyName}">${rst[i].classifyName}</option>`;
                }
                jQuery("#course").html(coursein);
            },method:'post'})
        var parm1={
            "id":locid
        }
        jQuery.post("/bank/papercontrol/showOne",parm1,function (rst) {
            $("input[id=foreWord]").val(rst.foreWord);
            var parm2={
                "courseID":rst.courseID
            }
            jQuery.post("/bank/edit/getCourse",parm2,function (rst1) {
                $("select[id=course]").val(rst1.classifyName);
                $("select[id=difficulty]").val(rst.difficulty);
                var o=rst.open;
                if(o==true){
                    $("select[id=isopen]").val("是");
                }else{
                    $("select[id=isopen]").val("否");
                }
                var que=`<div class="accordion" id="accordionExample">`;
                // questionids=rst.subjectIDs;
                // if(questionids.length==0){
                //     questionids=new Array();
                //     questionids[0]=new Array();
                // }
                questionids=new Array();
                questionids[0]=new Array();
                //清除空大题
                for(var cl=questionids.length-1;cl>=0;cl--){
                    if(questionids[cl].length==0){
                        questionids.splice(cl,1);
                    }
                }
                console.log(questionids);

                var tmp=questionids;
                var totalpoint=0;
                for(var i=0;i<tmp.length;i++){
                    var questiontable=`<table class="table">
                                        <thead class="thead-dark"><tr>
                                        <th scope="col">学科</th>
                                        <th scope="col">简介</th>
                                        <th scope="col">难度</th>
                                        <th scope="col">分值</th>
                                        <th scope="col"></th>
                                        </tr></thead>
                                        <tbody>`;
                    var t;//记录type
                    for (var j=0;j<tmp[i].length;j++){
                        var parm4={
                            "id":tmp[i][j]
                        }
                        jQuery.ajax({
                            type:'get',
                            url:"/bank/subject/json",
                            data:parm4,
                            async:false,//false代表只有在等待ajax执行完毕后才执行window.open('http://www.phpernote.com')语句
                            success:function (rst2){
                                rst2 = eval('('+rst2+')');
                                t=rst2.type;
                                //取出各个题目所属课程名
                                var coursename=null;
                                var parm5={
                                    "courseID":rst2.courseID
                                }
                                jQuery.ajax({
                                    type:'post',
                                    url:"/bank/edit/getCourse",
                                    data:parm5,
                                    async:false,
                                    success:function (r) {
                                        if(r.classifyName!=undefined){
                                            coursename=r.classifyName;
                                        }else{
                                            coursename="暂无课程信息";
                                        }
                                    }
                                })
                                questiontable+=`<tr id="${i}${j}">
                                    <td>${coursename}</td>
                                    <td>${rst2.introduction}</td>
                                    <td name="diff">${rst2.difficulty}</td>
                                    <td name="point">${rst2.recommendScore}</td>
                                    <td><!--button type="button" class="btn btn-light">修改分值</button-->
                                    <button type="button" class="btn btn-light" onclick="deleteQuestion(${i},${j})">移除</button></td>
                                    </tr>`;
                                totalpoint=totalpoint+rst2.recommendScore;
                            }
                        });
                    }
                    questiontable+=`
                                   <tr>
                                   <td><button type="button" class="btn btn-light" onclick="addQuestion(${i})">添加题目</button></td>
                                   <td><button type="button" class="btn btn-light" onclick="deleteHuge(${i})">删除大题</button></td>
                                   </tr>
                                   </tbody>
                                   </table>`;
                    var parm3={
                        "id":tmp[i][0]
                    }
                    jQuery.ajax({
                        type:'get',
                        url:"/bank/subject/json",
                        data:parm3,
                        async:false,//false代表只有在等待ajax执行完毕后才执行window.open('http://www.phpernote.com')语句
                        success:function (rst1){
                            rst1 = eval('('+rst1+')');
                            var qtype=null;
                            if(rst1.type==="singleChoiceQuestion"){
                                qtype="单选题";
                            }else if(rst1.type==="multipleChoiceQuestion"){
                                qtype="多选题";
                            }else if(rst1.type==="completion"){
                                qtype="填空题";
                            }else if(rst1.type==="judgment"){
                                qtype="判断题";
                            }else if(rst1.type==="comprehensiveQuestion"){
                                qtype="综合题";
                            }else if(rst1.type==="programProblem"){
                                qtype="程序题";
                            }else if(rst1.type==="combinationChoice"){
                                qtype="综合选择题"
                            }else {
                                qtype="未知题型";
                            }
                            que=que+`
                        <div class="card" id="${i}">
                            <div class="card-header" id="heading${i}">
                                <h2 class="mb-0">
                                    <button class="btn btn-link btn-block text-left" type="button" data-toggle="collapse" data-target="#collapse${i}" aria-expanded="true" aria-controls="collapse${i}">
                                        <div><div id="qtype${i}">${qtype}</div>
                                        <span class="badge badge-secondary" id="count${i}">${tmp[i].length}</span></div>
                                    </button>
                                </h2>
                            </div>

                            <div id="collapse${i}" class="collapse" aria-labelledby="heading${i}" data-parent="#accordionExample">
                                <div class="card-body" id="table${i}">
                                ${questiontable}
                                </div>
                            </div>
                        </div>
                        `;
                        }
                    });
                }
                que=que+`<button type="button" id="here" class="btn btn-primary" data-toggle="modal" data-target="#exampleModal" data-whatever="@mdo">添加大题</button>
                        <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                            <div class="modal-dialog modal-xl">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="exampleModalLabel">选择题目</h5>
                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                            <span aria-hidden="true">&times;</span>
                                        </button>
                                    </div>
                                    <div class="modal-body">
                                        <form>
                                            <div class="form-group">
                                                <label for="questionType" class="col-form-label">题目类型</label>
                                                <select class="form-control" id="questionType" onchange="selectChange()">
                                                    <option value="singleChoiceQuestion">单选题</option>
                                                    <option value="multipleChoiceQuestion">多选题</option>
                                                    <option value="completion">填空题</option>
                                                    <option value="judgment">判断题</option>
                                                    <option value="comprehensiveQuestion">综合题</option>
                                                    <option value="programProblem">程序题</option>
                                                    <option value="combinationChoice">组合选择题</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label>题目：</label>
                                                <div id="chooseQuestion"></div>
                                            </div>
                                        </form>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                                        <button type="button" class="btn btn-primary" onclick="submitAdd()">确定</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        </div>`;
                var lis=`<table class="table">
                                        <thead class="thead-dark"><tr>
                                        <th scope="col">学科</th>
                                        <th scope="col">简介</th>
                                        <th scope="col">难度</th>
                                        <th scope="col">分值</th>
                                        <th scope="col"></th>
                                        </tr></thead>
                                        <tbody>`;
                $.ajax(
                    {
                        type:'post',
                        url:'/bank/edit/getQuestions',
                        data:{
                            'course':$('#course').val(),
                            'type':'singleChoiceQuestion'
                        },
                        success:function (q) {
                            for(var a=0;a<q.length;a++){
                                lis+=`<tr id="${q[a].id}">
                                    <td><input name="addquestion" type="checkbox" value="${q[a].id}" /></td>
                                    <td>${$('#course').val()}</td>
                                    <td>${q[a].introduction}</td>
                                    <td>${q[a].difficulty}</td>
                                    <td>${q[a].recommendScore}</td>
                                    <td><!--button type="button" class="btn btn-light">修改分值</button-->
                                    <!--button type="button" class="btn btn-light" onclick="deleteQuestion(${i},${j})">移除</button--></td>
                                    </tr>`;
                            }
                            lis+=`
                                   <tr>
<!--                                   <td><button type="button" class="btn btn-light">添加题目</button></td>-->
<!--                                   <td><button type="button" class="btn btn-light">删除大题</button></td>-->
                                   </tr>
                                   </tbody>
                                   </table>`;
                            jQuery('#chooseQuestion').html(lis);
                        }
                    }
                )
                jQuery("#totalpoint").html(totalpoint);
                jQuery("#question").html(que);
            })
        })
    }
</script>
<script>
    function selectChange(){
        var list=`<table class="table">
                                        <thead class="thead-dark"><tr>
                                        <th scope="col"></th>
                                        <th scope="col">学科</th>
                                        <th scope="col">简介</th>
                                        <th scope="col">难度</th>
                                        <th scope="col">分值</th>
                                        <th scope="col"></th>
                                        </tr></thead>
                                        <tbody>`;
        $.ajax(
            {
                type:'post',
                url:'/bank/edit/getQuestions',
                data:{
                    'course':$("#course option:selected").val(),
                    'type':$("#questionType option:selected").val()
                },
                success:function (q) {
                    for(var a=0;a<q.length;a++){
                        list+=`<tr id="${q[a].id}">
                                    <td><input name="addquestion" type="checkbox" value="${q[a].id}" /></td>
                                    <td>${$('#course').val()}</td>
                                    <td>${q[a].introduction}</td>
                                    <td>${q[a].difficulty}</td>
                                    <td>${q[a].recommendScore}</td>
                                    <td>
                                    </td>
                                    </tr>`;
                    }
                    list+=`
                                   <tr>
<!--                                   <td><button type="button" class="btn btn-light">添加题目</button></td>-->
<!--                                   <td><button type="button" class="btn btn-light">删除大题</button></td>-->
                                   </tr>
                                   </tbody>
                                   </table>`;
                    jQuery('#chooseQuestion').html(list);
                }
            }
        )
    }
</script>
<script>
    function courseChange() {
        selectChange();
    }
</script>
<script>
    function submitAdd() {
        var chk_value =[];
        var type=$('#questionType option:selected').text();

        var queslist=`<table class="table">
                                        <thead class="thead-dark"><tr>
                                        <th scope="col">学科</th>
                                        <th scope="col">简介</th>
                                        <th scope="col">难度</th>
                                        <th scope="col">分值</th>
                                        <th scope="col"></th>
                                        </tr></thead>
                                        <tbody>`;
        var count=0;
        $('input[name="addquestion"]:checked').each(function(){
            chk_value.push($(this).val());
            jQuery.ajax({
                type:'get',
                url:"/bank/subject/json",
                data:{'id':$(this).val()},
                async:false,//false代表只有在等待ajax执行完毕后才执行window.open('http://www.phpernote.com')语句
                success:function (r1){
                    r1 = eval('('+r1+')');
                    queslist+=`<tr id="${questionids.length}${count}">
                                    <td>${$('#course').val()}</td>
                                    <td>${r1.introduction}</td>
                                    <td>${r1.difficulty}</td>
                                    <td>${r1.recommendScore}</td>
                                    <td><!--button type="button" class="btn btn-light">修改分值</button-->
                                    <button type="button" class="btn btn-light" onclick="deleteQuestion(${questionids.length},${count})">移除</button></td>
                                </tr>`;
                }
            });
            count++;
        });
        questionids.push(chk_value);
        console.log(questionids);
        queslist+=`<tr>
                       <td><button type="button" class="btn btn-light" onclick="addQuestion(${questionids.length-1})">添加题目</button></td>
                       <td><button type="button" class="btn btn-light" onclick="deleteHuge(${questionids.length-1})">删除大题</button></td>
                   </tr>
               </tbody>
           </table>`;
        var str=`<div class="card" id="${questionids.length-1}">
                    <div class="card-header" id="heading${questionids.length-1}">
                        <h2 class="mb-0">
                            <button class="btn btn-link btn-block text-left"
                                    type="button"
                                    data-toggle="collapse"
                                    data-target="#collapse${questionids.length-1}"
                                    aria-expanded="true"
                                    aria-controls="collapse${questionids.length-1}">
                                <div>
                                    <div id="qtype${questionids.length-1}">${type}</div>
                                    <span class="badge badge-secondary" id="count${questionids.length-1}">${chk_value.length}</span>
                                </div>
                            </button>
                        </h2>
                    </div>

                    <div id="collapse${questionids.length-1}"
                         class="collapse"
                         aria-labelledby="heading${questionids.length-1}"
                         data-parent="#accordionExample">
                        <div class="card-body" id="table${questionids.length-1}">
                        ${queslist}
                        </div>
                    </div>
                </div>`;
        $(function(){
            var index=questionids.length-2;
            if(index!=-1){
                //$("#"+index).after(str);
                $("#here").before(str);
            }else{
                $("#here").before(str);
            }
        });
        $('input[name="addquestion"]:checked').prop('checked', false);

        var int=0;
        $("[name='point']").each(function () {
            int=int+parseInt(this.innerText);
        });
        jQuery("#totalpoint").html(int);

        $('#exampleModal').modal('hide');
    }
</script>
<script>
    function addQuestion(i) {
        var qtype=$("#qtype"+i).html();
        $("#smallquestionType").find("option").each(function(){
            if($(this).text() == qtype)	{
                $(this).attr("selected",true);
            }else{
                $(this).attr("selected",false);
            }
        });
        $("#smallquestionType").attr("disabled","disabled");
        // $("#questionType").val(qtype);
        var lis=`<table class="table">
                                        <div hidden="hidden" id="dialogid">${i}</div>
                                        <thead class="thead-dark"><tr>
                                        <th scope="col">学科</th>
                                        <th scope="col">简介</th>
                                        <th scope="col">难度</th>
                                        <th scope="col">分值</th>
                                        <th scope="col"></th>
                                        </tr></thead>
                                        <tbody>`;
        $.ajax(
            {
                type:'post',
                url:'/bank/edit/getQuestions',
                data:{
                    'course':$('#course').val(),
                    'type':qtype
                },
                success:function (q) {
                    for(var a=0;a<q.length;a++){
                        lis+=`<tr id="${q[a].id}">
                                    <td><input name="smalladdquestion" type="checkbox" value="${q[a].id}" /></td>
                                    <td>${$('#course').val()}</td>
                                    <td>${q[a].introduction}</td>
                                    <td>${q[a].difficulty}</td>
                                    <td>${q[a].recommendScore}</td>
                                    <td></td>
                                    </tr>`;
                    }
                    lis+=`
                                   <tr>
<!--                                   <td><button type="button" class="btn btn-light">添加题目</button></td>-->
<!--                                   <td><button type="button" class="btn btn-light">删除大题</button></td>-->
                                   </tr>
                                   </tbody>
                                   </table>`;
                    jQuery('#chooseAddQuestion').html(lis);
                }
            }
        )
        $('#addModal').modal('show');
    }
</script>
<script>
    function submitAddSmall() {
        var i=$("#dialogid").text();
        console.log(i);
        var queslist=`<table class="table">
                                        <thead class="thead-dark"><tr>
                                        <th scope="col">学科</th>
                                        <th scope="col">简介</th>
                                        <th scope="col">难度</th>
                                        <th scope="col">分值</th>
                                        <th scope="col"></th>
                                        </tr></thead>
                                        <tbody>`;
        var count=0;
        $('input[name="smalladdquestion"]:checked').each(function(){
            questionids[i].push($(this).val());
            count++;
        });
        console.log(questionids);
        for(var c=0;c<questionids[i].length;c++){
            //判断这个题有没有被删掉
            var flag=1;
            var h=[parseInt(i),c];
            for(var f=0;f<remSma.length;f++){
                if(JSON.stringify(remSma[f])==JSON.stringify(h)){
                    flag=0;
                    break;
                }
                //alert(remSma[f].toString())
            }
            if(flag==1){
                jQuery.ajax({
                    type:'get',
                    url:"/bank/subject/json",
                    data:{'id':questionids[i][c]},
                    async:false,//false代表只有在等待ajax执行完毕后才执行window.open语句
                    success:function (r1){
                        r1 = eval('('+r1+')');
                        queslist+=`<tr id="${i}${c}">
                                    <td>${$('#course').val()}</td>
                                    <td>${r1.introduction}</td>
                                    <td id="diff">${r1.difficulty}</td>
                                    <td name="point">${r1.recommendScore}</td>
                                    <td><!--button type="button" class="btn btn-light">修改分值</button-->
                                    <button type="button" class="btn btn-light" onclick="deleteQuestion(${i},${c})">移除</button></td>
                                </tr>`;
                    }
                });
            }
        }
        queslist+=`<tr>
                       <td><button type="button" class="btn btn-light" onclick="addQuestion(${i})">添加题目</button></td>
                       <td><button type="button" class="btn btn-light" onclick="deleteHuge(${i})">删除大题</button></td>
                   </tr>
               </tbody>
           </table>`;

        jQuery("#table"+i).html(queslist);
        $('input[name="smalladdquestion"]:checked').prop('checked', false);

        //更新小题数
        var newcount=parseInt($("#count"+i).html())+count;
        jQuery("#count"+i).html(newcount);

        //更新总分
        var int=0;
        $("[name='point']").each(function () {
            int=int+parseInt(this.innerText);
        });
        jQuery("#totalpoint").html(int);


        $('#addModal').modal('hide');
    }
</script>
<script>
    var remSma=[];
    function deleteQuestion(i,j) {
        //questionids[i].splice(j,1);
        $("#"+i+j).remove();

        var newcount=parseInt($("#count"+i).html())-1;
        jQuery("#count"+i).html(newcount);

        var int=0;
        $("[name='point']").each(function () {
            int=int+parseInt(this.innerText);
        });
        jQuery("#totalpoint").html(int);
        remSma.push([i,j]);
        console.log(remSma);
    }
</script>
<script>
    var remHuge=[];
    function deleteHuge(i) {
        $("#"+i).remove();
        var int=0;
        $("[name='point']").each(function () {
            int=int+parseInt(this.innerText);
        });
        jQuery("#totalpoint").html(int);
        // for(var j=i+1;j<questionids.length;j++){
        //     $("#"+j).attr("id",j-1);
        // }
        //questionids.splice(i,1);
        remHuge.push(i);
        console.log(remHuge);
    }
</script>
</html>
