<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>批阅试卷</title>
    <link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    <script src="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
</head>

<body onload="init()">

<div class="modal" tabindex="-1" id="dialog1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">提示</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>本试卷还未批完是否提交？</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal" onclick="hideDialog()">取消</button>
                <button type="button" class="btn btn-primary" onclick="goback()">确定</button>
            </div>
        </div>
    </div>
</div>
<div id="container">
    //信息
    <div id="info"></div>
    //导航
    <div class="accordion" id="accordionExample" style="width:20%; height:80%;">
    </div>
    //主界面
    <div id="review">

    </div>
    <button onclick="finishReview()">完成</button>
    <button onclick="b()">返回</button>
</div>
</body>
<script>
    var subject;
    var txt;
    var scorelist;
    function init(){
        // var loc=location.href;
        // var n1 = loc.length;
        // var n2 = loc.indexOf('=');
        // var txt = decodeURI(loc.substr(n2+1,n1-n2));
        txt=window.sessionStorage.getItem("detialId");
        console.log(txt);
        jQuery.ajax({
            type:'post',
            url:'/teacher/reviewpaper/getScoreList',
            async : false,
            data:{'id':txt},
            success:function (rst) {
                scorelist=rst;
            }
        })
        jQuery.ajax({
            type:'post',
            url:'/teacher/reviewpaper/autoandget',
            data:{'id':txt},
            success:function (rst) {
                console.log(rst);
                var rightGuide=``;
                var table=``;
                subject=rst.answers;
                var c=0;
                var count=0;
                var information=`
                <div>答题人：${rst.username}</div>
                <div>科目：${sessionStorage.getItem("examName")}</div>
                <div>切屏次数：${rst.antiCount}</div>
                <div id="scoreGot">考试得分：${rst.totalScore}</div>
                `;
                var r=``;
                jQuery("#info").html(information);
                for(var i=0;i<subject.length;i++){
                    if((i>=1&&subject[i].subjectType!=subject[i-1].subjectType)||i==0){
                        //jQuery("#"+c).html(table);
                        c++;
                        table=``;
                        table+=`<a href="#mark-${count}">${count+1}</a>`;
                        rightGuide+=`
                        <div class="card">
                            <div class="card-header" id="heading${c}">
                                <h2 class="mb-0">
                                    <button class="btn btn-link btn-block text-left" type="button" data-toggle="collapse" data-target="#collapse${c}" aria-expanded="true" aria-controls="collapse${c}">
                                        ${subject[i].subjectType}
                                    </button>
                                </h2>
                            </div>
                            <div id="collapse${c}" class="collapse" aria-labelledby="heading${c}" data-parent="#accordionExample">
                                <div class="card-body">
                                    <div id="a${c}">${table}</div>
                                </div>
                            </div>
                        </div>
                        `;
                        jQuery("#accordionExample").html(rightGuide);
                    }else{
                        table+=`<a href="#mark-${count}">${count+1}</a>`;
                        jQuery("#a2").html(table);
                        rightGuide=jQuery("#accordionExample").html();
                    }
                    //显示题目
                    console.log(subject[i].answerList);
                    jQuery.ajax({
                        type:'get',
                        url:'/bank/subject/json',
                        async : false,
                        data:{'id':subject[i].subjectId},
                        success:function (back) {
                            back = eval('('+back+')');
                            var anser;
                            var stuanswer;
                            switch (back.type) {
                                case "singleChoiceQuestion":
                                    anser="正确答案："+back.answer;
                                    stuanswer=subject[i].answerList;
                                    break;
                                case "multipleChoiceQuestion":
                                    anser="正确答案：";
                                    stuanswer="";
                                    for(let ans in back.answers){
                                        anser+=ans;
                                    }
                                    // for(let ans2 in subject[i].answerList){
                                    //     stuanswer+=ans2;
                                    // }
                                    stuanswer=subject[i].answerList;
                                    break;
                                case "completion":
                                    anser="正确答案："+back.answer;
                                    stuanswer=subject[i].answerList;
                                    break
                                case "judgment":
                                    let answer1 = back.answer;
                                    let answer = '';
                                    answer = answer + back.options[answer1 - 1];
                                    anser="正确答案："+answer;

                                    let a = subject[i].answerList;
                                    let as = '';
                                    as = as + subject[i].options[a - 1];
                                    stuanswer=as;
                                    break;
                                case "comprehensiveQuestion":
                                    anser="正确答案："+back.answer;
                                    stuanswer=subject[i].answerList;
                                    break;
                                case "programProblem":
                                    anser="正确答案："+back.answer;
                                    stuanswer=subject[i].answerList;
                                    break;
                                case "CombinationChoice":

                            }
//subject[i].answerList
                            if(back.answer!=undefined){
                                r+=`
                                <div id="mark-${count}">
                                    <div><p class="text-break">题目${count+1}：${back.description}</p></div>
                                    <div>分值：${scorelist[count]}</div>
                                    <div>学生作答情况：${stuanswer}</div>
                                    <div id="ans${count}">${anser}</div>
                                    <div>
                                        得分判定:<input type="text" id="score${count}" value="${subject[i].score}" onchange="changeScore(${count})"/>
                                    </div>
                                </div>
                                `;
                            }else if(back.answers!=undefined){
                                r+=`
                                <div id="mark-${count}">
                                    <div><p class="text-break">题目：${back.description}</p></div>
                                    <div>分值：${scorelist[count]}</div>
                                    <div>学生作答情况：${stuanswer}</div>
                                    <div id="ans${count}">${anser}</div>
                                    <div>
                                        得分判定:<input type="text" id="score${count}" value="${subject[i].score}" onchange="changeScore(${count})"/>
                                    </div>
                                </div>
                                `;
                            }

                        }
                    })
                    count++;
                }
                jQuery("#review").html(r);
                //jQuery("#accordionExample").html(rightGuide);
            }
        })

    }
</script>
<script>
    function changeScore(id) {
        var score = parseInt(jQuery("#score"+id).val());
        if (!isNaN(score)) { //数字

        }
        else//字符
        {
            alert("请输入合适的数字");
            jQuery("#score"+id).val(subject[id].score);
            return;
        }
        if(score<0){
            alert("分值请勿低于0");
            jQuery("#score"+id).val(0);
            score=0;
        }else if(score>scorelist[id]){
            alert("分值请勿超过最大分值");
            jQuery("#score"+id).val(scorelist[id]);
            score=scorelist[id];
        }
        subject[id].score=score;
        console.log(subject);
        jQuery.ajax({
            type:'post',
            url:'/teacher/reviewpaper/changeScore',
            async : false,
            data:{
                'id':txt,
                'Answer':JSON.stringify(subject)
            },
            success:function (rst) {

            }
        })
        var totalScore=parseInt(0);
        for(var i=0;i<subject.length;i++){
            totalScore=totalScore+parseInt(subject[i].score);
        }
        jQuery.ajax({
            type:'post',
            url:'/teacher/reviewpaper/changeTotalScore',
            async : false,
            data:{
                'id':txt,
                'score':totalScore
            },
            success:function (rst) {
                jQuery("#scoreGot").html("考试得分："+totalScore);
            }
        })

    }
</script>
<script>
    function FR() {
        jQuery("#dialog1").show();
    }
</script>
<script>
    function hideDialog() {
        jQuery("#dialog1").hide();
    }
</script>
<script>
    function goback() {
        location.href="paperList.html";
    }
</script>
<script>
    function finishReview() {
        for(var i=0;i<subject.length;i++){
            if(subject[i].score==-1){
                FR();
                return;
            }
        }
        jQuery.ajax({
            type:'post',
            url:'/teacher/reviewpaper/finishReview',
            data:{
                'id':txt
            },
            success:function (rst) {
                location.href="paperList.html";
            }
        })
    }
</script>
<script>
    function b() {
        location.href="paperList.html";
    }
</script>
</html>